<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simulation TVA & Marge</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        margin: 0;
        padding: 1.5rem;
        background: #f5f5f5;
        color: #222;
      }

      .container {
        max-width: 960px;
        margin: 0 auto;
        display: grid;
        gap: 1.5rem;
      }

      .card {
        background: #fff;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      }

      h1,
      h2 {
        margin-top: 0;
      }

      form fieldset {
        border: none;
        margin: 0 0 1rem;
        padding: 0;
        display: flex;
        gap: 1rem;
      }

      .grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      label {
        display: flex;
        flex-direction: column;
        font-weight: 600;
        gap: 0.25rem;
      }

      input[type='number'] {
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 1rem;
      }

      button[type='submit'] {
        margin-top: 1rem;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        border: none;
        border-radius: 4px;
        background: #0053b3;
        color: #fff;
        cursor: pointer;
      }

      button[type='submit']:hover {
        background: #003f80;
      }

      .error {
        color: #c20a0a;
        min-height: 1.25rem;
      }

      .hidden {
        display: none;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      table th,
      table td {
        border-bottom: 1px solid #ddd;
        padding: 0.75rem;
        text-align: left;
      }

      table tbody tr:last-child td {
        border-bottom: none;
      }

      @media (prefers-color-scheme: dark) {
        body {
          background: #121212;
          color: #f1f1f1;
        }

        .card {
          background: #1f1f1f;
          box-shadow: none;
        }

        input[type='number'] {
          background: #2a2a2a;
          color: inherit;
          border-color: #444;
        }

        table th,
        table td {
          border-bottom-color: #333;
        }
      }
    </style>
  </head>
  <body>
    <main class="container">
      <h1>Simulation de prix et de marge</h1>
      <section class="card">
        <h2>Paramètres</h2>
        <form id="simulation-form" novalidate>
          <fieldset>
            <legend>Scénario</legend>
            <label>
              <input type="radio" name="scenario" value="purchaseAndSale" checked />
              Prix d'achat + prix de vente
            </label>
            <label>
              <input type="radio" name="scenario" value="purchaseAndTargetMargin" />
              Prix d'achat + marge cible
            </label>
          </fieldset>

          <div class="grid">
            <label>
              Prix d'achat HT (€)
              <input type="number" id="purchasePriceHT" min="0" step="0.01" required />
            </label>
            <label data-scenario="purchaseAndSale">
              Prix de vente HT (€)
              <input type="number" id="salePriceHT" min="0" step="0.01" required />
            </label>
            <label data-scenario="purchaseAndTargetMargin" class="hidden">
              Marge cible (% du prix de vente)
              <input type="number" id="targetMarginRate" min="0" max="99.99" step="0.01" />
            </label>
            <label>
              TVA (%)
              <input type="number" id="vatRate" min="0" step="0.01" value="20" />
            </label>
            <label>
              Impôt sur les sociétés (%)
              <input type="number" id="corporateTaxRate" min="0" step="0.01" value="25" />
            </label>
            <label>
              Autres contributions (% du bénéfice)
              <input type="number" id="otherContributionsRate" min="0" step="0.01" value="0" />
            </label>
          </div>
          <p id="form-error" class="error" aria-live="polite"></p>
          <button type="submit">Calculer</button>
        </form>
      </section>

      <section class="card" aria-live="polite">
        <h2>Résultats</h2>
        <table id="results-table">
          <thead>
            <tr>
              <th>Indicateur</th>
              <th>Valeur</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <section class="card">
        <h2>Hypothèses fiscales</h2>
        <p>
          Les calculs sont réalisés sur des montants hors taxes. La TVA et l'impôt sur les
          sociétés sont appliqués selon les taux renseignés. Les autres contributions sont
          exprimées en pourcentage du bénéfice imposable (marge brute positive). Aucun
          amortissement ou charge supplémentaire n'est pris en compte.
        </p>
      </section>
    </main>

    <script>
      (function () {
        const form = document.getElementById('simulation-form');
        const resultBody = document.querySelector('#results-table tbody');
        const errorContainer = document.getElementById('form-error');
        const scenarioInputs = form.querySelectorAll("input[name='scenario']");
        const scenarioFields = form.querySelectorAll('[data-scenario]');

        function updateScenarioFields() {
          const selected = form.querySelector("input[name='scenario']:checked").value;
          scenarioFields.forEach((field) => {
            const shouldShow = field.getAttribute('data-scenario') === selected;
            field.classList.toggle('hidden', !shouldShow);
            const input = field.querySelector('input');
            if (input) {
              input.required = shouldShow;
              if (!shouldShow) {
                input.value = '';
              }
            }
          });
          errorContainer.textContent = '';
          resultBody.innerHTML = '';
        }

        scenarioInputs.forEach((input) => input.addEventListener('change', updateScenarioFields));

        function getLabelText(input) {
          const label = input.closest('label');
          if (!label) return input.id;
          const textNode = Array.from(label.childNodes).find((node) => node.nodeType === Node.TEXT_NODE);
          return textNode ? textNode.textContent.trim() : label.textContent.trim();
        }

        function parseField(id) {
          const input = document.getElementById(id);
          const value = input.value.trim();
          const labelText = getLabelText(input);
          if (value === '') {
            throw new Error(`Le champ ${labelText} est obligatoire.`);
          }
          const number = Number(value);
          if (Number.isNaN(number) || number < 0) {
            throw new Error(`La valeur saisie pour ${labelText} doit être positive.`);
          }
          return number;
        }

        function parseOptionalField(id) {
          const input = document.getElementById(id);
          const value = input.value.trim();
          if (value === '') {
            return 0;
          }
          const number = Number(value);
          const labelText = getLabelText(input);
          if (Number.isNaN(number) || number < 0) {
            throw new Error(`La valeur saisie pour ${labelText} doit être positive.`);
          }
          return number;
        }

        function formatCurrency(value) {
          return new Intl.NumberFormat('fr-FR', {
            style: 'currency',
            currency: 'EUR',
            minimumFractionDigits: 2,
          }).format(value);
        }

        function formatPercent(value) {
          return `${(value * 100).toFixed(2)} %`;
        }

        function normalizeRate(rate) {
          if (typeof rate !== 'number' || Number.isNaN(rate)) {
            throw new Error('Le taux doit être un nombre.');
          }
          if (rate < 0) {
            throw new Error('Le taux ne peut pas être négatif.');
          }
          return rate > 1 ? rate / 100 : rate;
        }

        function validatePrice(value, fieldName) {
          if (typeof value !== 'number' || Number.isNaN(value) || value < 0) {
            throw new Error(`La valeur ${fieldName} doit être un nombre positif.`);
          }
        }

        function calculateWithSalePrice({
          purchasePriceHT,
          salePriceHT,
          vatRate,
          corporateTaxRate,
          otherContributionsRate = 0,
        }) {
          validatePrice(purchasePriceHT, 'purchasePriceHT');
          validatePrice(salePriceHT, 'salePriceHT');

          const vat = normalizeRate(vatRate);
          const corporate = normalizeRate(corporateTaxRate);
          const other = normalizeRate(otherContributionsRate);

          const vatAmount = salePriceHT * vat;
          const salePriceTTC = salePriceHT + vatAmount;
          const grossMargin = salePriceHT - purchasePriceHT;
          const grossMarginRate = salePriceHT === 0 ? 0 : grossMargin / salePriceHT;

          const taxableProfit = Math.max(grossMargin, 0);
          const corporateTax = taxableProfit * corporate;
          const otherContributions = taxableProfit * other;
          const netProfit = taxableProfit - corporateTax - otherContributions;

          return {
            scenario: 'purchaseAndSale',
            purchasePriceHT,
            salePriceHT,
            salePriceTTC,
            vatAmount,
            vatRate: vat,
            grossMargin,
            grossMarginRate,
            taxableProfit,
            corporateTax,
            corporateTaxRate: corporate,
            otherContributions,
            otherContributionsRate: other,
            netProfit,
          };
        }

        function calculateWithTargetMargin({
          purchasePriceHT,
          targetMarginRate,
          vatRate,
          corporateTaxRate,
          otherContributionsRate = 0,
        }) {
          validatePrice(purchasePriceHT, 'purchasePriceHT');

          const marginRate = normalizeRate(targetMarginRate);
          if (marginRate >= 1) {
            throw new Error('La marge cible doit être inférieure à 100 %.');
          }
          const salePriceHT = purchasePriceHT / (1 - marginRate);
          const base = calculateWithSalePrice({
            purchasePriceHT,
            salePriceHT,
            vatRate,
            corporateTaxRate,
            otherContributionsRate,
          });

          return {
            ...base,
            scenario: 'purchaseAndTargetMargin',
            targetMarginRate: marginRate,
          };
        }

        function buildRows(result) {
          const rows = [
            ["Prix d'achat HT", formatCurrency(result.purchasePriceHT)],
            ["Prix de vente HT", formatCurrency(result.salePriceHT)],
            ["Prix de vente TTC", formatCurrency(result.salePriceTTC)],
            ["TVA collectée", `${formatCurrency(result.vatAmount)} (${formatPercent(result.vatRate)})`],
            ["Marge brute", `${formatCurrency(result.grossMargin)} (${formatPercent(result.grossMarginRate)})`],
            ["Bénéfice imposable", formatCurrency(result.taxableProfit)],
            [
              "Impôt sur les sociétés",
              `${formatCurrency(result.corporateTax)} (${formatPercent(result.corporateTaxRate)})`,
            ],
            [
              'Autres contributions',
              `${formatCurrency(result.otherContributions)} (${formatPercent(result.otherContributionsRate)})`,
            ],
            ['Résultat net', formatCurrency(result.netProfit)],
          ];

          if (result.scenario === 'purchaseAndTargetMargin') {
            rows.unshift(['Marge cible', formatPercent(result.targetMarginRate)]);
          }

          return rows;
        }

        form.addEventListener('submit', (event) => {
          event.preventDefault();
          errorContainer.textContent = '';

          try {
            const scenario = form.querySelector("input[name='scenario']:checked").value;
            const purchasePriceHT = parseField('purchasePriceHT');
            const vatRate = parseField('vatRate');
            const corporateTaxRate = parseField('corporateTaxRate');
            const otherContributionsRate = parseOptionalField('otherContributionsRate');

            let result;
            if (scenario === 'purchaseAndSale') {
              const salePriceHT = parseField('salePriceHT');
              result = calculateWithSalePrice({
                purchasePriceHT,
                salePriceHT,
                vatRate,
                corporateTaxRate,
                otherContributionsRate,
              });
            } else {
              const targetMarginRate = parseField('targetMarginRate');
              result = calculateWithTargetMargin({
                purchasePriceHT,
                targetMarginRate,
                vatRate,
                corporateTaxRate,
                otherContributionsRate,
              });
            }

            const rows = buildRows(result);
            resultBody.innerHTML = '';
            rows.forEach(([label, value]) => {
              const tr = document.createElement('tr');
              const tdLabel = document.createElement('td');
              tdLabel.textContent = label;
              const tdValue = document.createElement('td');
              tdValue.textContent = value;
              tr.append(tdLabel, tdValue);
              resultBody.appendChild(tr);
            });
          } catch (error) {
            if (error instanceof Error) {
              errorContainer.textContent = error.message;
            } else {
              errorContainer.textContent = 'Une erreur inattendue est survenue.';
            }
            resultBody.innerHTML = '';
          }
        });

        updateScenarioFields();

        // Pré-remplissage léger pour faciliter les tests rapides dans le navigateur
        form.purchasePriceHT.value = '100';
        form.salePriceHT.value = '150';
        form.targetMarginRate.value = '30';
        form.otherContributionsRate.value = '0';
        form.vatRate.value = '20';
        form.corporateTaxRate.value = '25';
      })();
    </script>
  </body>
</html>
